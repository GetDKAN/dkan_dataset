## Customize the test machine
machine:

  timezone:
    America/New_York # Set the timezone

  # Version of ruby to use
  php:
    version: '5.5.11'

  # Add some environment variables
  environment:
    # For xvfb / selenium setup (not sure why)
    #DISPLAY: ':99.0'
    DATABASE_URL: mysql://ubuntu:@127.0.0.1:3306/circle_test
## Customize checkout
## Note: Only post is supported.
checkout:
  post:
    # Remove the extra composer stuff that circleci loads and that is causing conflicts with drush.
    - rm -rf ~/.composer

## Customize dependencies
dependencies:

  cache_directories:
     #- "test/vendor"
     #- "~/.composer"
     #- "~/.drush"
     #- "~/backups"
     #- "test/sites/default"
  override:
    - mkdir $CIRCLE_ARTIFACTS/junit
    - 'bash dkan-module-init.sh --deps --build=$DATABASE_URL'
    - 'ahoy drush --yes runserver :8888':
        background: true

    # Setup display for selenium
    #- sh -e /etc/init.d/xvfb start
    #- sleep 3

    - wget http://selenium-release.storage.googleapis.com/2.48/selenium-server-standalone-2.48.2.jar
    - java -jar selenium-server-standalone-2.48.2.jar -quiet -p 4444 -log shut_up_selenium :
        background: true
  post:
     - sudo apt-get install -y x11vnc
     - x11vnc -forever -nopw:
        background: true


## Customize test commands
test:
  override:
  # Fix for behat bug not recognizing symlinked feature files.
  #  - bash dkan/test/circle-behat.sh  docroot/profiles/dkan/modules/dkan/dkan_workflow/test/features docroot/profiles/dkan/test/features:
     - bash dkan/test/circle-behat.sh  docroot/profiles/dkan/test/features:
        parallel: true
  post:
    - echo $CIRCLE_ARTIFACTS; cp -av dkan/test/assets $CIRCLE_ARTIFACTS:
        parallel: true
